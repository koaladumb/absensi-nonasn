<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Absensi Wajah Karyawan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    #video { transform: scaleX(-1); }
    canvas { position: absolute; }
    #video-container.hidden { display: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl transform transition-all duration-300 hover:scale-105">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Aplikasi Absensi Wajah</h1>

    <!-- Kamera -->
    <div id="video-container" class="relative w-full aspect-video bg-gray-900 rounded-xl overflow-hidden shadow-lg mb-4 flex items-center justify-center hidden">
      <video id="video" autoplay muted class="w-full h-full object-cover"></video>
      <canvas id="canvas" class="absolute inset-0 w-full h-full"></canvas>
      <div id="loading-indicator" class="absolute text-white font-bold text-xl flex flex-col items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent"></div>
        <p class="mt-2 text-sm">Memuat model...</p>
      </div>
      <div id="status-message" class="absolute bottom-4 text-white text-sm bg-gray-800 bg-opacity-70 px-3 py-1 rounded-full">
        Menunggu deteksi wajah...
      </div>
    </div>

    <!-- Input + Tombol -->
    <div id="controls" class="flex flex-col space-y-4">
      <input type="text" id="employee-name" placeholder="Masukkan Nama Karyawan" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
      <button id="register-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-green-700 transition-all duration-300 transform hover:-translate-y-1 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
        Daftar Wajah
      </button>
      <div class="grid grid-cols-2 gap-4">
        <button id="check-in-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:-translate-y-1 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
          Absen Masuk
        </button>
        <button id="check-out-btn" class="w-full bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-orange-700 transition-all duration-300 transform hover:-translate-y-1 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
          Absen Pulang
        </button>
      </div>
    </div>

    <!-- Tabel Riwayat -->
    <div class="mt-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Riwayat Absensi</h2>
      <div class="bg-gray-50 rounded-xl p-4 shadow-inner max-h-96 overflow-y-auto">
        <table class="w-full text-left table-auto">
          <thead>
            <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
              <th class="py-3 px-6 text-center">Nama</th>
              <th class="py-3 px-6 text-center">Waktu Masuk</th>
              <th class="py-3 px-6 text-center">Waktu Pulang</th>
            </tr>
          </thead>
          <tbody id="attendance-list" class="text-gray-600 text-sm font-light"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Script utama -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, query, where, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const videoContainer = document.getElementById('video-container');
    const checkInBtn = document.getElementById('check-in-btn');
    const checkOutBtn = document.getElementById('check-out-btn');
    const registerBtn = document.getElementById('register-btn');
    const employeeNameInput = document.getElementById('employee-name');
    const loadingIndicator = document.getElementById('loading-indicator');
    const statusMessage = document.getElementById('status-message');
    const attendanceList = document.getElementById('attendance-list');
    const allButtons = [registerBtn, checkInBtn, checkOutBtn];

    let attendanceAction = null;
    let detectionInterval;
    let faceMatcher = null;
    let stream = null;
    const FACE_THRESHOLD = 0.6;

    const modelsUrl = 'https://koaladumb.github.io/absen-nonasn/models';
    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(modelsUrl),
      faceapi.nets.faceLandmark68Net.loadFromUri(modelsUrl),
      faceapi.nets.faceRecognitionNet.loadFromUri(modelsUrl)
    ]).then(() => {
      loadingIndicator.style.display = 'none';
      statusMessage.textContent = 'Model siap. Silakan klik tombol absen.';
    }).catch(err => {
      console.error("Kesalahan saat memuat model: ", err);
      statusMessage.textContent = 'Gagal memuat model pengenalan wajah.';
      loadingIndicator.style.display = 'none';
    });

    function startVideo() {
      videoContainer.classList.remove('hidden');
      allButtons.forEach(btn => {
        btn.disabled = (btn.id !== attendanceAction);
      });

      navigator.mediaDevices.getUserMedia({ video: {} })
        .then(s => {
          stream = s;
          video.srcObject = stream;
          video.addEventListener('play', detectFaces);
        })
        .catch(err => {
          console.error("Kesalahan saat mengakses kamera: ", err);
          statusMessage.textContent = 'Gagal mengakses kamera. Mohon berikan izin.';
          stopVideo();
        });
    }

    function stopVideo() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      clearInterval(detectionInterval);
      videoContainer.classList.add('hidden');
      statusMessage.textContent = 'Menunggu deteksi wajah...';
      attendanceAction = null;
      allButtons.forEach(btn => btn.disabled = false);
    }

    // Pendaftaran wajah
    registerBtn.addEventListener('click', async () => {
      const employeeName = employeeNameInput.value.trim();
      if (!employeeName) {
        statusMessage.textContent = 'Nama karyawan harus diisi untuk pendaftaran.';
        return;
      }

      attendanceAction = 'register-btn';
      startVideo();
      statusMessage.textContent = 'Memindai wajah... Mohon tetap di depan kamera.';

      setTimeout(async () => {
        const detectionWithDescriptor = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

        if (!detectionWithDescriptor) {
          statusMessage.textContent = 'Tidak ada wajah yang terdeteksi. Silakan posisikan wajah Anda di depan kamera.';
          stopVideo();
          return;
        }

        try {
          const userId = getUserId();
          const faceId = employeeName.replace(/\s+/g, '-').toLowerCase();
          const faceProfileRef = doc(collection(db, getFaceProfileCollectionPath()), faceId);

          await setDoc(faceProfileRef, {
            name: employeeName,
            descriptor: JSON.stringify(Array.from(detectionWithDescriptor.descriptor)),
            timestamp: serverTimestamp()
          });
          statusMessage.textContent = `Wajah ${employeeName} berhasil didaftarkan!`;
          employeeNameInput.value = '';
        } catch (e) {
          console.error("Error registering face: ", e);
          statusMessage.textContent = 'Gagal mendaftarkan wajah.';
        }
        stopVideo();
      }, 5000);
    });

    // Absen masuk
    checkInBtn.addEventListener('click', async () => {
      const employeeName = employeeNameInput.value.trim();
      if (!employeeName) {
        statusMessage.textContent = 'Nama karyawan harus diisi.';
        return;
      }
      attendanceAction = 'check-in-btn';
      startVideo();
      statusMessage.textContent = 'Mencari wajah untuk Absen Masuk...';
    });

    // Absen pulang
    checkOutBtn.addEventListener('click', async () => {
      const employeeName = employeeNameInput.value.trim();
      if (!employeeName) {
        statusMessage.textContent = 'Nama karyawan harus diisi.';
        return;
      }
      attendanceAction = 'check-out-btn';
      startVideo();
      statusMessage.textContent = 'Mencari wajah untuk Absen Pulang...';
    });

    async function detectFaces() {
      detectionInterval = setInterval(async () => {
        if (!faceMatcher) return;

        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

        if (detections) {
          const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
          const recognizedName = bestMatch.label;
          const distance = bestMatch.distance;

          if (recognizedName !== 'unknown' && distance < FACE_THRESHOLD) {
            employeeNameInput.value = recognizedName;
            statusMessage.textContent = `Wajah dikenali: ${recognizedName}. Merekam absensi...`;
            handleAttendance(recognizedName);
          } else {
            statusMessage.textContent = 'Wajah tidak dikenal. Silakan daftar terlebih dahulu.';
          }
        } else {
          statusMessage.textContent = 'Menunggu deteksi wajah...';
        }
      }, 500);
    }

    async function handleAttendance(recognizedName) {
      if (!attendanceAction) return;

      try {
        if (attendanceAction === 'check-in-btn') {
          await addDoc(collection(db, getCollectionPath()), {
            name: recognizedName,
            checkInTime: serverTimestamp(),
            checkOutTime: null
          });
          statusMessage.textContent = 'Absensi masuk berhasil!';
        } else if (attendanceAction === 'check-out-btn') {
          const q = query(collection(db, getCollectionPath()), where('name', '==', recognizedName), where('checkOutTime', '==', null));
          const querySnapshot = await getDocs(q);

          if (querySnapshot.empty) {
            statusMessage.textContent = 'Tidak ada data absensi masuk yang ditemukan atau sudah absen pulang.';
            return;
          }

          const latestDoc = querySnapshot.docs.reduce((latest, current) => {
            return (latest.data().checkInTime.toDate() > current.data().checkInTime.toDate()) ? latest : current;
          });
          await updateDoc(doc(db, getCollectionPath(), latestDoc.id), {
            checkOutTime: serverTimestamp()
          });
          statusMessage.textContent = 'Absensi pulang berhasil!';
        }
      } catch (e) {
        console.error("Error storing attendance: ", e);
        statusMessage.textContent = 'Gagal menyimpan absensi.';
      } finally {
        stopVideo();
      }
    }

    async function authenticate() {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
          console.log("Berhasil autentikasi dengan token kustom.");
        } else {
          await signInAnonymously(auth);
          console.log("Berhasil autentikasi secara anonim.");
        }
      } catch (error) {
        console.error("Kesalahan saat autentikasi:", error);
      }
    }

    function getUserId() {
      return auth.currentUser?.uid || 'anonim';
    }

    function getCollectionPath() {
      return `/artifacts/${firebaseConfig.projectId}/users/${getUserId()}/absensi-wajah`;
    }

    function getFaceProfileCollectionPath() {
      return `/artifacts/${firebaseConfig.projectId}/users/${getUserId()}/face-profiles`;
    }

    // Listen Firebase
    auth.onAuthStateChanged(user => {
      if (user) {
        onSnapshot(collection(db, getCollectionPath()), (snapshot) => {
          attendanceList.innerHTML = '';
          snapshot.forEach((doc) => {
            const data = doc.data();
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-100 transition-colors';

            const formattedCheckInTime = data.checkInTime ? new Date(data.checkInTime.seconds * 1000).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
            const formattedCheckOutTime = data.checkOutTime ? new Date(data.checkOutTime.seconds * 1000).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }) : 'Belum absen pulang';

            row.innerHTML = `
              <td class="py-3 px-6 text-center">${data.name}</td>
              <td class="py-3 px-6 text-center">${formattedCheckInTime}</td>
              <td class="py-3 px-6 text-center">${formattedCheckOutTime}</td>
            `;
            attendanceList.appendChild(row);
          });
        });

        onSnapshot(collection(db, getFaceProfileCollectionPath()), (snapshot) => {
          const labeledDescriptors = snapshot.docs.map(doc => {
            const data = doc.data();
            const descriptor = JSON.parse(data.descriptor);
            return new faceapi.LabeledFaceDescriptors(data.name, [new Float32Array(descriptor)]);
          });

          faceMatcher = labeledDescriptors.length > 0 ? new faceapi.FaceMatcher(labeledDescriptors) : null;
        });
      }
    });

    authenticate();
  </script>
</body>
</html>
