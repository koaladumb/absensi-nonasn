<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Kehadiran Karyawan (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .input-field {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
        .input-field:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }
        .btn-primary {
            background-color: #238636;
        }
        .btn-primary:hover {
            background-color: #2ea043;
        }
        .btn-secondary {
            background-color: #30363d;
        }
        .btn-secondary:hover {
            background-color: #444c56;
        }
        .text-late {
            color: #f85149;
        }
        .text-ontime {
            color: #3fb950;
        }
        .text-overtime {
            color: #a476e3;
        }
        .text-undertime {
            color: #c9d1d9;
        }
        .table-header {
            background-color: #21262d;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">
    <div class="card p-6 rounded-xl shadow-md w-full max-w-2xl mb-6">
        <h1 class="text-2xl md:text-3xl font-bold mb-2 text-center">Rekapitulasi Kehadiran Karyawan</h1>
        <p class="text-xs text-gray-500 mb-4 text-center">ID Pengguna Saat Ini: <span id="userIdDisplay" class="font-mono text-xs text-gray-400">Loading...</span></p>
        <p class="text-sm md:text-base text-gray-400 text-center mb-6">Kelola waktu masuk dan keluar Anda dengan mudah.</p>

        <div class="mb-6 space-y-4">
            <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                <div class="w-full md:w-1/2">
                    <label for="standardIn" class="block text-sm font-medium mb-1">Waktu Masuk Standar</label>
                    <input type="time" id="standardIn" class="input-field w-full rounded-lg p-2.5">
                </div>
                <div class="w-full md:w-1/2">
                    <label for="standardOut" class="block text-sm font-medium mb-1">Waktu Keluar Standar</label>
                    <input type="time" id="standardOut" class="input-field w-full rounded-lg p-2.5">
                </div>
            </div>
            <div class="flex gap-2">
                <button id="saveSettingsBtn" class="btn-primary w-full text-white font-semibold py-2 rounded-lg transition-colors">Simpan Pengaturan</button>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-2 mb-6">
            <button id="inBtn" class="btn-primary w-full text-white font-semibold py-2 rounded-lg transition-colors">Masuk</button>
            <button id="outBtn" class="btn-secondary w-full text-white font-semibold py-2 rounded-lg transition-colors">Keluar</button>
        </div>

        <div id="modalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
            <div id="modal" class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
                <p id="modalMessage" class="mb-6"></p>
                <div id="modalActions" class="flex justify-end gap-2"></div>
            </div>
        </div>
        
        <div id="reportContainer" class="card p-4 rounded-xl shadow-md">
            <h2 class="text-xl font-bold mb-4">Rekapitulasi Kehadiran</h2>
            <div id="reportContent" class="overflow-x-auto">
                <table id="reportTable" class="min-w-full divide-y divide-gray-700">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Tanggal</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Masuk</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Keluar</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Durasi</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody" class="divide-y divide-gray-800">
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Mengatur level log ke "debug" untuk melihat output detail
        setLogLevel('debug');

        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let unsubscribe;

        // --- DOM Elements ---
        const standardInInput = document.getElementById('standardIn');
        const standardOutInput = document.getElementById('standardOut');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const inBtn = document.getElementById('inBtn');
        const outBtn = document.getElementById('outBtn');
        const reportBody = document.getElementById('reportBody');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const modalContainer = document.getElementById('modalContainer');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');

        const SETTINGS_COLLECTION = "settings";
        const RECORDS_COLLECTION = "attendance_records"; // Menggunakan nama koleksi yang benar dari database pengguna

        // --- Firebase Initialization ---
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                userIdDisplay.textContent = userId;
                
                // Logging untuk debug
                console.log("Firebase berhasil diinisialisasi.");
                console.log("App ID:", appId);
                console.log("User ID:", userId);
                console.log("Menggunakan path koleksi:", RECORDS_COLLECTION);

                await loadSettings();
                listenToRecords();

            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase:", error);
                showModal("Kesalahan", `Gagal menginisialisasi Firebase. Silakan periksa koneksi internet Anda atau hubungi dukungan. Detail: ${error.message}`);
            }
        }
        
        // --- Modal Functions ---
        function showModal(title, message, actions = []) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalActions.innerHTML = '';
            
            if (actions.length > 0) {
                actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = `px-4 py-2 rounded-lg text-white font-semibold transition-colors ${action.className}`;
                    btn.textContent = action.text;
                    btn.onclick = () => {
                        action.handler();
                        hideModal();
                    };
                    modalActions.appendChild(btn);
                });
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'px-4 py-2 rounded-lg text-white font-semibold transition-colors btn-primary';
                okBtn.textContent = 'OK';
                okBtn.onclick = hideModal;
                modalActions.appendChild(okBtn);
            }

            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        }

        function hideModal() {
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
        }

        // --- Firebase Operations ---
        async function loadSettings() {
            if (!db || !userId) return;

            const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/${SETTINGS_COLLECTION}`, 'user_settings');
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    standardInInput.value = settings.standardIn || '08:00';
                    standardOutInput.value = settings.standardOut || '17:00';
                }
            } catch (error) {
                console.error("Kesalahan saat memuat pengaturan:", error);
            }
        }

        async function saveSettings() {
            if (!db || !userId) return;
            const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/${SETTINGS_COLLECTION}`, 'user_settings');
            
            const settings = {
                standardIn: standardInInput.value,
                standardOut: standardOutInput.value
            };

            try {
                await setDoc(settingsDocRef, settings);
                showModal("Berhasil", "Pengaturan berhasil disimpan.");
            } catch (error) {
                console.error("Kesalahan saat menyimpan pengaturan:", error);
                showModal("Kesalahan", "Gagal menyimpan pengaturan.");
            }
        }

        function listenToRecords() {
            if (unsubscribe) {
                unsubscribe();
            }

            if (!db || !userId) return;
            const recordsCollectionRef = collection(db, RECORDS_COLLECTION);
            
            // Mengambil semua dokumen di koleksi
            unsubscribe = onSnapshot(recordsCollectionRef, (snapshot) => {
                const allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const userRecords = allRecords.filter(record => record.username === userId || record.username === undefined);

                // Mengelompokkan records berdasarkan tanggal
                const groupedRecords = userRecords.reduce((acc, record) => {
                    if (record.timestamp) {
                        const recordDate = new Date(record.timestamp).toISOString().slice(0, 10);
                        if (!acc[recordDate]) {
                            acc[recordDate] = {};
                        }
                        // Menangani data Masuk & Keluar
                        if (record.type === 'Masuk' && !acc[recordDate].in) {
                            acc[recordDate].in = record;
                        } else if (record.type === 'Keluar' && !acc[recordDate].out) {
                            acc[recordDate].out = record;
                        }
                    }
                    return acc;
                }, {});

                renderReport(groupedRecords);
            }, (error) => {
                console.error("Kesalahan saat mendengarkan records:", error);
                showModal("Kesalahan Koneksi", "Gagal memperbarui data real-time. Periksa koneksi internet Anda.");
            });
        }

        async function addRecord(type) {
            if (!db || !userId) return;

            const recordsCollectionRef = collection(db, RECORDS_COLLECTION);
            
            try {
                const newRecord = {
                    timestamp: Date.now(),
                    type: type,
                    username: userId,
                    // Tambahkan data lokasi jika diperlukan
                    location: {
                        latitude: -7.1897427,
                        longitude: 113.4785018
                    }
                };
                await addDoc(recordsCollectionRef, newRecord);
                showModal("Berhasil", `Waktu ${type} Anda telah dicatat.`);
            } catch (error) {
                console.error(`Kesalahan saat mencatat waktu ${type}:`, error);
                showModal("Kesalahan", `Gagal mencatat waktu ${type}.`);
            }
        }
        
        async function deleteRecord(recordId) {
            if (!db || !userId) return;
            try {
                const recordDocRef = doc(db, RECORDS_COLLECTION, recordId);
                await deleteDoc(recordDocRef);
                showModal("Berhasil", "Catatan berhasil dihapus.");
            } catch (error) {
                console.error("Kesalahan saat menghapus catatan:", error);
                showModal("Kesalahan", "Gagal menghapus catatan.");
            }
        }

        // --- UI & Reporting ---
        function renderReport(groupedRecords) {
            reportBody.innerHTML = '';
            const recordDates = Object.keys(groupedRecords).sort((a, b) => new Date(b) - new Date(a));

            if (recordDates.length === 0) {
                reportBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">Belum ada catatan kehadiran.</td></tr>';
                return;
            }

            const standardIn = standardInInput.value;
            const standardOut = standardOutInput.value;

            recordDates.forEach(date => {
                const record = groupedRecords[date];
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800 transition-colors duration-200';

                const inTime = record.in ? new Date(record.in.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                const outTime = record.out ? new Date(record.out.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
                const displayDate = new Date(date).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                
                let duration = 'N/A';
                let statusClass = '';
                let statusText = 'Tidak Lengkap';

                if (record.in && record.out) {
                    const msDuration = record.out.timestamp - record.in.timestamp;
                    duration = formatDuration(msDuration);
                    
                    const [standardInHours, standardInMinutes] = standardIn.split(':').map(Number);
                    const [standardOutHours, standardOutMinutes] = standardOut.split(':').map(Number);
                    
                    const inDate = new Date(record.in.timestamp);
                    const inHour = inDate.getHours();
                    const inMinute = inDate.getMinutes();

                    const outDate = new Date(record.out.timestamp);
                    const outHour = outDate.getHours();
                    const outMinute = outDate.getMinutes();
                    
                    // Status Masuk
                    if (inHour > standardInHours || (inHour === standardInHours && inMinute > standardInMinutes)) {
                        statusText = 'Terlambat';
                        statusClass = 'text-late';
                    } else {
                        statusText = 'Tepat Waktu';
                        statusClass = 'text-ontime';
                    }

                    // Status Keluar (Overtime/Undertime)
                    const standardOutTimeInMinutes = standardOutHours * 60 + standardOutMinutes;
                    const outTimeInMinutes = outHour * 60 + outMinute;
                    
                    if (outTimeInMinutes > standardOutTimeInMinutes + 10) { // Toleransi 10 menit
                        statusText += ' / Lembur';
                        statusClass += ' text-overtime';
                    } else if (outTimeInMinutes < standardOutTimeInMinutes - 10) {
                        statusText += ' / Pulang Cepat';
                        statusClass += ' text-undertime';
                    }
                }

                row.innerHTML = `
                    <td class="px-4 py-2">${displayDate}</td>
                    <td class="px-4 py-2">${inTime}</td>
                    <td class="px-4 py-2">${outTime}</td>
                    <td class="px-4 py-2">${duration}</td>
                    <td class="px-4 py-2 ${statusClass} font-semibold">${statusText}</td>
                    <td class="px-4 py-2">
                        ${record.in ? `<button class="delete-btn btn-secondary px-3 py-1 text-sm rounded-lg" data-id="${record.in.id}" data-date="${date}">Hapus Masuk</button>` : ''}
                        ${record.out ? `<button class="delete-btn btn-secondary px-3 py-1 text-sm rounded-lg" data-id="${record.out.id}" data-date="${date}">Hapus Keluar</button>` : ''}
                    </td>
                `;
                reportBody.appendChild(row);
            });
        }
        
        // --- Helper Functions ---
        function formatDuration(ms) {
            if (ms <= 0) return '0m';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);

            let parts = [];
            if (hours > 0) parts.push(`${hours}j`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.join(' ') || '0m';
        }

        // --- Event Listeners ---
        window.addEventListener('load', () => {
            initFirebase();
        });

        saveSettingsBtn.addEventListener('click', saveSettings);
        inBtn.addEventListener('click', () => addRecord('Masuk'));
        outBtn.addEventListener('click', () => addRecord('Keluar'));

        reportBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const recordId = e.target.getAttribute('data-id');
                const date = e.target.getAttribute('data-date');
                showModal(
                    "Konfirmasi Hapus",
                    `Apakah Anda yakin ingin menghapus catatan pada ${date}?`,
                    [
                        {
                            text: "Ya, Hapus",
                            className: "btn-primary",
                            handler: () => deleteRecord(recordId)
                        },
                        {
                            text: "Batal",
                            className: "btn-secondary",
                            handler: hideModal
                        }
                    ]
                );
            }
        });
    </script>
</body>
</html>
